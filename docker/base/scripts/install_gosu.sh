#!/bin/bash

set -ex

GOSU_VERSION=${GOSU_VERSION:-1.14}
ARCH=${ARCH:-amd64}
PREFIX=${PREFIX:-/usr/local}

# gpg --keyserver hkp://keyserver.ubuntu.com:80 \
#     --recv-keys B42F6819007F00F88E364FD4036A9C25BF357DD4

# Key retrieval would sometimes fail during the build, to I
# have embedded tianon's public key in the script.

cat << 'PUBKEY' > /tmp/pubkey.asc
-----BEGIN PGP PUBLIC KEY BLOCK-----

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
=m/ie
-----END PGP PUBLIC KEY BLOCK-----
PUBKEY

curl -sSL "https://github.com/tianon/gosu/releases/download/$GOSU_VERSION/gosu-$ARCH" -o /tmp/gosu
curl -sSL "https://github.com/tianon/gosu/releases/download/$GOSU_VERSION/gosu-$ARCH.asc" -o /tmp/gosu.asc

gpg --import /tmp/pubkey.asc
gpg --verify /tmp/gosu.asc
rm /tmp/gosu.asc

mv /tmp/gosu "$PREFIX/bin/gosu"
chmod +x "$PREFIX/bin/gosu"
